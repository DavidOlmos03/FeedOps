{
  "name": "Telegram Dispatcher",
  "nodes": [
    {
      "parameters": {},
      "id": "workflow-trigger",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Format message for Telegram based on source type\nconst data = $input.item.json;\n\n// Determine priority emoji\nconst priorityEmojis = {\n  github: {\n    push: 'ğŸ“',\n    issues: 'ğŸ›',\n    pull_request: 'ğŸ”€',\n    release: 'ğŸš€'\n  },\n  reddit: 'ğŸ”¥',\n  rss: 'ğŸ“°'\n};\n\nlet emoji = 'ğŸ“¢';\nif (data.source === 'github' && priorityEmojis.github[data.event_type]) {\n  emoji = priorityEmojis.github[data.event_type];\n} else if (priorityEmojis[data.source]) {\n  emoji = priorityEmojis[data.source];\n}\n\n// Build message\nlet message = `${emoji} **${data.title}**\\n\\n`;\n\nif (data.description) {\n  message += `${data.description}\\n\\n`;\n}\n\n// Add metadata based on source\nif (data.source === 'github') {\n  message += `ğŸ“¦ Repository: \\`${data.repository}\\`\\n`;\n  if (data.metadata?.branch) {\n    message += `ğŸŒ¿ Branch: \\`${data.metadata.branch}\\`\\n`;\n  }\n  if (data.metadata?.commits) {\n    message += `ğŸ’¾ Commits: ${data.metadata.commits}\\n`;\n  }\n} else if (data.source === 'reddit') {\n  message += `ğŸ‘¤ Author: u/${data.author}\\n`;\n  message += `ğŸ’¬ r/${data.metadata?.subreddit}\\n`;\n  message += `â¬†ï¸ Score: ${data.metadata?.score} | ğŸ’­ Comments: ${data.metadata?.num_comments}\\n`;\n} else if (data.source === 'rss') {\n  message += `ğŸ“¡ Feed: ${data.metadata?.feed_title}\\n`;\n  if (data.author !== 'Unknown') {\n    message += `âœï¸ Author: ${data.author}\\n`;\n  }\n}\n\n// Add timestamp\nconst date = new Date(data.timestamp);\nmessage += `â° ${date.toLocaleString('en-US', { \n  month: 'short', \n  day: 'numeric', \n  hour: '2-digit', \n  minute: '2-digit' \n})}\\n`;\n\n// Add URL\nif (data.url) {\n  message += `\\nğŸ”— [View ${data.source === 'github' ? 'on GitHub' : data.source === 'reddit' ? 'on Reddit' : 'source'}](${data.url})`;\n}\n\nreturn {\n  message: message,\n  parse_mode: 'Markdown',\n  disable_web_page_preview: false,\n  source_data: data\n};"
      },
      "id": "format-message",
      "name": "Format Message",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "authentication": "botToken",
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{$env.TELEGRAM_DEFAULT_CHAT_ID}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": false,
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "ğŸ”— Open",
                  "url": "={{$json.source_data.url}}"
                }
              ]
            ]
          }
        }
      },
      "id": "send-telegram",
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [650, 300],
      "credentials": {
        "telegramApi": {
          "id": "3",
          "name": "Telegram Bot"
        }
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE notifications_history SET telegram_message_id = $1 WHERE item_id = $2",
        "options": {
          "queryParameters": {
            "parameters": [
              {
                "name": "1",
                "value": "={{$json.message.message_id}}"
              },
              {
                "name": "2",
                "value": "={{$json.source_data.item_id}}"
              }
            ]
          }
        }
      },
      "id": "update-notification",
      "name": "Update Notification",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "functionCode": "// Error handler with exponential backoff\nconst error = $json.error;\nconst attempt = $json.attempt || 1;\nconst maxRetries = parseInt($env.MAX_RETRIES || '3');\n\nif (attempt < maxRetries) {\n  // Calculate backoff time\n  const backoffMultiplier = parseInt($env.RETRY_BACKOFF_MULTIPLIER || '2');\n  const backoffTime = Math.pow(backoffMultiplier, attempt) * 1000;\n  \n  console.log(`Telegram send failed (attempt ${attempt}/${maxRetries}), retrying in ${backoffTime}ms...`);\n  \n  return {\n    ...$input.item.json,\n    attempt: attempt + 1,\n    retry_after: backoffTime\n  };\n}\n\n// Max retries reached - log error\nconsole.error(`Failed to send Telegram notification after ${maxRetries} attempts:`, error);\n\n// Send alert to admin channel if configured\nif ($env.ALERT_TELEGRAM_CHAT_ID) {\n  return {\n    alert: true,\n    message: `âš ï¸ Failed to send notification after ${maxRetries} attempts\\n\\nError: ${error.message}\\n\\nItem: ${$json.source_data?.title}`\n  };\n}\n\nreturn null;"
      },
      "id": "error-handler",
      "name": "Error Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [650, 500]
    },
    {
      "parameters": {
        "amount": "={{$json.retry_after}}",
        "unit": "milliseconds"
      },
      "id": "wait-backoff",
      "name": "Wait (Backoff)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [850, 500]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.alert}}",
              "value2": true
            }
          ]
        }
      },
      "id": "should-alert",
      "name": "Should Alert?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "authentication": "botToken",
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{$env.ALERT_TELEGRAM_CHAT_ID}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-alert",
      "name": "Send Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1250, 400]
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [[{ "node": "Format Message", "type": "main", "index": 0 }]]
    },
    "Format Message": {
      "main": [[{ "node": "Send to Telegram", "type": "main", "index": 0 }]]
    },
    "Send to Telegram": {
      "main": [
        [{ "node": "Update Notification", "type": "main", "index": 0 }],
        [{ "node": "Error Handler", "type": "main", "index": 0 }]
      ]
    },
    "Error Handler": {
      "main": [[{ "node": "Should Alert?", "type": "main", "index": 0 }]]
    },
    "Wait (Backoff)": {
      "main": [[{ "node": "Send to Telegram", "type": "main", "index": 0 }]]
    },
    "Should Alert?": {
      "main": [[{ "node": "Send Alert", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}
